<!DOCTYPE html>
<html lang="en">
<head>
  <%- include("../../partials/header"); %>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shop Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .order-card {
      border: 2px solid #003366;
      border-radius: 10px;
      background-color: #f9f9f9;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 20px;
    }
    .order-card:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .order-header {
      background-color: #003366;
      color: #fff;
      padding: 10px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    .order-body {
      padding: 20px;
    }
    .order-actions button {
      background-color: #FFD700;
      border-color: #FFD700;
      color: #003366;
      font-weight: bold;
    }
    .order-actions button:hover {
      background-color: #003366;
      color: #FFD700;
    }
    .filter-form {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #003366;
      border-radius: 10px;
      background-color: #e9ecef;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center text-primary mb-4" style="font-family: 'Arial', sans-serif; font-weight: bold;">Shop Orders</h1>

    <!-- Filter Form (similar to the Flutter Card with DropdownButtons) -->
    <form class="filter-form" method="GET" action="/products/shop-orders">
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="sortFilter" class="form-label"><strong>Sort By:</strong></label>
          <select class="form-select" id="sortFilter" name="sortFilter">
            <option value="Recent First" <%= selectedTimeFilter === "Recent First" ? "selected" : "" %>>Recent First</option>
            <option value="Oldest First" <%= selectedTimeFilter === "Oldest First" ? "selected" : "" %>>Oldest First</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="statusFilter" class="form-label"><strong>Order Status:</strong></label>
          <select class="form-select" id="statusFilter" name="statusFilter">
            <option value="All" <%= selectedStatusFilter === "All" ? "selected" : "" %>>All</option>
            <option value="Completed" <%= selectedStatusFilter === "Completed" ? "selected" : "" %>>Completed</option>
            <option value="Partially Completed" <%= selectedStatusFilter === "Partially Completed" ? "selected" : "" %>>Partially Completed</option>
            <option value="Not Completed" <%= selectedStatusFilter === "Not Completed" ? "selected" : "" %>>Not Completed</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="paymentFilter" class="form-label"><strong>Payment Status:</strong></label>
          <select class="form-select" id="paymentFilter" name="paymentFilter">
            <option value="All" <%= selectedPaymentFilter === "All" ? "selected" : "" %>>All</option>
            <option value="success" <%= selectedPaymentFilter === "success" ? "selected" : "" %>>success</option>
            <option value="pending" <%= selectedPaymentFilter === "pending" ? "selected" : "" %>>pending</option>
            <option value="Unpaid" <%= selectedPaymentFilter === "Unpaid" ? "selected" : "" %>>Unpaid</option>
            <option value="Unknown" <%= selectedPaymentFilter === "Unknown" ? "selected" : "" %>>Unknown</option>
          </select>
        </div>
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Apply Filters</button>
        <a href="/shop-orders" class="btn btn-secondary ms-2">Reset</a>
      </div>
    </form>

    <% if (orders.length > 0) { %>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <% orders.forEach(order => { 
             // Format the creation date
             const createdAt = new Date(order.createdAt);
             const formattedDate = createdAt.toLocaleString();

             // Determine overall order status (the same logic as on the server)
             let overallStatus = "Not Completed";
             if (order.products && order.products.length > 0) {
               const deliveredCount = order.products.filter(p => (p.status || "").toLowerCase() === "delivered").length;
               if (deliveredCount === order.products.length) {
                 overallStatus = "Completed";
               } else if (deliveredCount > 0) {
                 overallStatus = "Partially Completed";
               }
             }
        %>
        <div class="col">
          <div class="order-card shadow-sm">
            <div class="order-header">
              <h5 class="mb-0">Order #<%= order.orderId || "N/A" %></h5>
            </div>
            <div class="order-body">
              <p><strong>Order Date:</strong> <%= formattedDate %></p>
              <p><strong>Total Price:</strong> $<%= order.totalAmount.toFixed(2) %></p>
              <p>
                <strong>Payment Status:</strong> 
                <span class="badge bg-<%= order.paymentStatus === "success" ? "success" : order.paymentStatus === "pending" ? "warning" : "secondary" %>">
                  <%= order.paymentStatus %>
                </span>
              </p>
			<% if (order.paymentStatus === 'success') { %>
            <!-- Instead of an inline JS function, use a direct link to the verification route -->
            <a href="/checkout/verifyPayment/<%= order.orderId %>" class="btn btn-sm btn-success me-2">
              <i class="fas fa-check-circle"></i> Verify Payment
            </a>
            <% } %>
              <p>
                <strong>Order Status:</strong> 
                <span class="badge bg-<%= overallStatus === "Completed" ? "success" : overallStatus === "Partially Completed" ? "info" : "danger" %>">
                  <%= overallStatus %>
                </span>
              </p>
              <p>
                <strong>Products:</strong>
                <% if (order.products && order.products.length > 0) { %>
                  <ul class="list-unstyled">
                  <% order.products.forEach(product => { %>
                    <li>
                      <%= product.title || "Unnamed Product" %> - 
                      <span class="badge bg-<%= product.status === "Pending" ? "warning" : product.status === "Shipped" ? "info" : product.status === "Delivered" ? "success" : product.status === "Cancelled" ? "danger" : "secondary" %>">
                        <%= product.status %>
                      </span>
                    </li>
                  <% }) %>
                  </ul>
                <% } else { %>
                  No products available.
                <% } %>
              </p>
            </div>
<div class="order-actions d-flex justify-content-end p-3" style="display: flex; justify-content: flex-end; padding: 1rem;">
  <a href="/products/shop-order-details/<%= order.orderId %>" class="btn btn-sm" style="display: inline-block; padding: .25rem .5rem; font-size: .875rem; line-height: 1.5; border-radius: .2rem; color: #fff; background-color: #007bff; border-color: #007bff; text-decoration: none;">Details</a>
</div>

          </div>
        </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="text-center mt-5">
        <p class="text-muted">No orders found. <a href="/shop-orders" class="text-primary">Refresh to try again.</a></p>
      </div>
    <% } %>
  </div>
   <script>
	if (window.self !== window.top) {
	  document.addEventListener("DOMContentLoaded", () => {
		// Hide navbar and footer if in iframe
		document.querySelector('.navbar').style.display = 'none'; // Hide navbar
		document.querySelector('footer').style.display = 'none'; // Hide footer
	  });
	}
 </script>
  <%- include("../../partials/footer"); %>
</body>
</html>
