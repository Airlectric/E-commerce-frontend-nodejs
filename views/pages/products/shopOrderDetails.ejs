<!DOCTYPE html>
<html lang="en">
<head>
  <%- include("../../partials/header") %>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .card-custom {
      border: 2px solid #003366;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .card-custom .card-header {
      background-color: #003366;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center text-primary mb-4">Order Details</h1>
    
    <!-- Customer Details Section -->
    <div class="card card-custom">
      <div class="card-body">
        <div class="text-center">
          <img src="<%= userDetails.profileImageUrl %>" alt="Profile Image" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
        </div>
        <h5 class="mt-3">Customer Name: <%= userDetails.name %></h5>
        <p>Username: <%= userDetails.username %></p>
        <p>Email: <%= userDetails.email %></p>
      </div>
    </div>

    <!-- Order Details Section -->
    <div class="card card-custom">
      <div class="card-body">
        <h4>Order ID: <%= order.orderId %></h4>
        <% 
          // Format the order's creation date
          const createdAt = new Date(order.createdAt);
          const formattedDate = createdAt.getFullYear() + '-' +
                (createdAt.getMonth() + 1).toString().padStart(2, '0') + '-' +
                createdAt.getDate().toString().padStart(2, '0') + ' ' +
                createdAt.getHours().toString().padStart(2, '0') + ':' +
                createdAt.getMinutes().toString().padStart(2, '0');
        %>
        <p>Date: <%= formattedDate %></p>
        <h5 class="mt-4">Products:</h5>
        <ul class="list-group mb-3">
          <% order.products.forEach(product => { %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong><%= product.title %></strong> (x<%= product.quantity %>)<br>
                <small>Status: <span id="status-<%= product.productId %>"><%= product.status %></span></small>
              </div>
              <div>
                <select class="form-select form-select-sm" 
                        onchange="updateProductStatus('<%= order.orderId %>', '<%= product.productId %>', this.value)" 
                        style="width: auto;">
                  <% ['Pending', 'Shipped', 'Delivered', 'Cancelled'].forEach(statusOption => { %>
                    <option value="<%= statusOption %>" <%= product.status === statusOption ? 'selected' : '' %>><%= statusOption %></option>
                  <% }); %>
                </select>
              </div>
            </li>
          <% }); %>
        </ul>
        <h4>Total Amount: $<%= order.totalAmount %></h4>
      </div>
    </div>
  </div>

  <!-- Client-side JavaScript to update product status -->
  <script>
    async function updateProductStatus(orderId, productId, newStatus) {
      console.log(`Attempting to update status for product ${productId} in order ${orderId} to ${newStatus}`);
      try {
        // Use a relative URL because the PATCH route is exposed on the same domain.
        const url = `/products/orders/${orderId}/product/${productId}/status`;
        console.log(`URL: ${url}`);

        const requestOptions = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        };
        console.log('Request options:', requestOptions);

        console.log('Sending the request...');
        const response = await fetch(url, requestOptions);
        console.log('Response received:', response);

        const data = await response.json();
        console.log('Response data:', data);

        if (response.ok) {
          console.log('Request was successful.');
          // Update the displayed status on success
          const statusElement = document.getElementById('status-' + productId);
          if (statusElement) {
            console.log('Status element found, updating text...');
            statusElement.innerText = newStatus;
          } else {
            console.warn(`Status element with ID 'status-${productId}' not found.`);
          }
          alert('Product status updated to ' + newStatus);
        } else {
          console.error('Request failed.');
          console.error('Response status:', response.status);
          console.error('Response message:', data.message);
          alert('Error: ' + (data.message || 'An unknown error occurred'));
        }
      } catch (error) {
        console.error('An error occurred during the fetch operation:', error);
        alert('Error updating product status. See console for details.');
      } finally {
        console.log(`Finished processing status update for product ${productId} in order ${orderId}.`);
      }
    }
  </script>
  <%- include("../../partials/footer") %>
</body>
</html>
